<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <ItemGroup>
    <Watch Include="**\*.graphql" />
    <Watch Include="**\berry.json" />
    <Compile Update="**\Generated\**\*.cs" Watch="false" />
  </ItemGroup>

  <Target Name="GenerateJsonResource" BeforeTargets="BeforeBuild" Condition="'@(JsonResource)' != ''" />

  <!-- Extension points. -->
  <Target Name="GraphQL_BeforeCompile" />
  <Target Name="GraphQL_AfterCompile" />

  <!-- Main compile sequence. Certain steps are gated by the value $(DisableProtobufDesignTimeBuild),
       so the sequence is good for either design time or build time. -->
  <Target
    Name="GraphQL_Compile"
    Condition="'@(GraphQL)' != ''"
    DependsOnTargets="GraphQL_BeforeCompile
                  GraphQL_CoreCompile
                  GraphQL_AfterCompile" />


  <Target Name="GraphQL_CoreCompile">
    <PropertyGroup>
      <BerryLangVersion Condition="'$(Nullable)'=='enable' AND '$(LangVersion)'=='8.0'">CSharp_8_0</BerryLangVersion>
      <BerryLangVersion Condition="'$(BerryLangVersion)'==''">CSharp_7_3</BerryLangVersion>
      <BerryEnableDI Condition="'$(BerryEnableDI)'==''">true</BerryEnableDI>
      <BerryNamespace Condition="'$(BerryNamespace)'=='' AND '$(RootNamespace)'!=''">$(RootNamespace)</BerryNamespace>
      <BerryCommand>dotnet graphql generate "$(MSBuildProjectDirectory)" -s</BerryCommand>
      <BerryCommand>$(BerryCommand) -l $(BerryLangVersion)</BerryCommand>
      <BerryCommand Condition="'$(BerryEnableDI)'=='true'">$(BerryCommand) -d</BerryCommand>
      <BerryCommand Condition="'$(BerryNamespace)'!=''">$(BerryCommand) -n $(BerryNamespace)</BerryCommand>
    </PropertyGroup>

    <Message Text="$(BerryCommand)" Importance="High" />
    <Exec Command="$(BerryCommand)" WorkingDirectory="$(MSBuildProjectDirectory)" IgnoreExitCode="true" />
  </Target>

</Project>
